<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoGora - Ride Management</title>
  <link rel="stylesheet" href="admin.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Markazi+Text:wght@400..700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/assets/favicon.png">

  <style>
    /* Ride-specific styles */
    .image-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .image-buttons {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .window-controls {
      position: absolute;
      right: 10px;
      top: 10px;
      display: flex;
      gap: 8px;
    }

    .window-control {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      color: rgb(255, 255, 255);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .minimize {
      background-color: #edd132;
      color: black;
    }
    
    .maximize {
      background-color: #34A853;
      color: black;
    }
    
    .close-btn {
      background-color: #c73421;
      color: black;
    }

    .window-control:hover {
      opacity: 0.8;
    }

    .modal-content.minimized {
      transform: scale(0.7);
      width: 70%;
      margin-top: 80vh;
      opacity: 0.8;
    }

    .modal-content.maximized {
      width: 95vw;
      max-width: none;
      height: 90vh;
      margin: 5vh auto;
    }

    #imagePreviewModal .modal-content {
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      min-height: 400px;
    }

    #previewImage {
      max-width: 90%;
      max-height: 80vh;
      object-fit: contain;
      margin: auto;
      display: block;
    }

    /* Adjust the window controls to stay at the top */
    #imagePreviewModal .window-controls {
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 1001;

      padding: 5px;
    }

    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      margin: 20px;
      min-height: 200px;
      position: relative;
    }

    .upload-area.drag-over {
      border-color: #4285F4;
      background: rgba(66, 133, 244, 0.1);
    }

    .upload-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 15px;
    }

    .upload-status {
      margin-top: 15px;
      color: #666;
    }

    .file-info {
      margin-top: 10px;
      font-size: 14px;
      color: #4285F4;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 15px;
    }

    .select-btn {
      background: #4285F4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .select-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .error-message {
      color: #c73421;
      margin-top: 10px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;  /* Space between buttons */
      align-items: center;
    }

    .add-ride, .delete-ride, .download-csv {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      color: white;
    }

    .download-csv {
      background-color: #4285F4;
      color: white;
    }

    .add-ride:hover, .delete-ride:hover, .download-csv:hover {
      opacity: 0.9;
    }
    .add-ride:hover, .delete-ride:hover{
      background-color: #0A3981;
    }

    /* Add these styles */
    .delete-mode .edit-btn {
      display: none;
    }

    .delete-mode .ride-item {
      background-color: rgba(199, 52, 33, 0.1);
    }

    .delete-instructions {
      margin: 15px 0;
      color: #666;
    }

    #confirmDeleteModal .modal-content,
    #successModal .modal-content {
      max-width: 400px;
      text-align: center;
    }

    .modal-content h3 {
      margin-top: 20px;
    }

    /* Style for checkboxes */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      position: relative;
      width: 80%;
      max-width: 800px;
    }

    /* Make sure checkboxes are visible */
    input[type="checkbox"] {
      margin: 0;
      padding: 0;
      visibility: visible;
      display: inline-block;
    }

    /* Style for the delete mode table */
    #delete-rides-container .ride-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    #delete-rides-container .ride-item:hover {
      background-color: rgba(199, 52, 33, 0.05);
    }

  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="logo">
        <h2><span style="color: #4285F4;">Go</span><span style="color: #FBBC05;">Go</span><span style="color: #FBBC05;">Ra</span></h2>
      </div>
      <nav>
        <ul class="menu">
          <li><a href="index.html" class="menu-item"><i class="icon">üè†</i> Dashboard</a></li>
          <li><a href="ride_manager.html" class="menu-item"><i class="icon">üõ£Ô∏è</i> Manage Rides</a>
            <a href="ride.html" class="menu-item" style="padding-left: 45px;"><i class="icon">üöñ</i> Rides</a>
            <a href="schedules.html" class="menu-item" style="padding-left: 45px;"><i class="icon">üìÖ</i> Schedules</a>
          </li>
          <li><a href="account_manager.html" class="menu-item"><i class="icon">üë•</i> Manage Accounts</a></li>
          <li><a href="statistics.html" class="menu-item"><i class="icon">üìä</i> Statistics</a></li>
          <li><a href="blacklist.html" class="menu-item"><i class="icon">üö´</i> Blacklist Passengers</a></li>
        </ul>
      </nav>
    </aside>
    <main class="main-content">
      <div class="title-section">
        <h1>Manage Rides</h1>
      </div>

      <div class="search-filters">
        <h3> Search:</h3>
        <input type="text" id="searchInput" placeholder="Search Rides" oninput="filterRides()">
        <h3> Ride ID:</h3>
        <select id="filterPlateNumber">
          <option value="">Filter by Ride ID</option>
        </select>
          <h3> Route:</h3>
        <select id="filterRoute">
          <option value="">Filter by Route</option>
        </select>
          <h3> Departure:</h3>
        <select id="filterDeparture">
          <option value="">Filter by Departure</option>
        </select>
        <h3> Available Seats: </h3>
        <select id="filterSeatsAvailable">
          <option value="">Filter by Seats Available</option>
        </select>
        <button onclick="applyFilters()">Apply</button>
        <button onclick="clearFilters()">Clear All</button>
      </div>

      <div class="rides-section">
        <div class="header-buttons-container">
          <h2>Rides</h2>
          <div class="action-buttons">
            <button class="add-ride" onclick="toggleAddRideMode()">Add Ride</button>
            <button class="delete-ride" onclick="toggleDeleteMode()">Delete Ride</button>
            <button class="download-csv" onclick="downloadRidesCSV()">Download CSV</button>
          </div>
        </div>
        <div class="ride-item header">
          <p>Ride ID</p>
          <p>Plate Number</p>
          <p>Image</p>
          <p>Route</p>
          <p>Departure</p>
          <p>Seats Available</p>
        </div>
        <div id="rides-container">
          <!-- Ride items will be populated dynamically here -->
        </div>
      </div>

      <!-- Add this modal structure after your rides-section div -->
      <div id="addRideModal" class="modal">
        <div class="modal-content">
          <div class="window-controls">
            <button class="window-control minimize" title="Minimize" onclick="minimizeModal('addRideModal')">‚îÄ</button>
            <button class="window-control maximize" title="Maximize" onclick="maximizeModal('addRideModal')">‚ñ°</button>
            <button class="window-control close-btn" title="Close" onclick="closeAddRideModal()">√ó</button>
          </div>
          <h2>Add New Ride</h2>
          <form id="addRideForm">
            <div class="form-group">
              <label for="addPlateNumber">Plate Number</label>
              <input type="text" id="addPlateNumber" name="plate_number" maxlength="6" required>
            </div>

            <div class="form-group">
              <label for="addRoute">Route</label>
              <input type="text" id="addRoute" name="route" required>
            </div>

            <div class="form-group">
              <label for="addDeparture">Departure Time</label>
              <input type="datetime-local" id="addDeparture" name="departure" required>
            </div>

            <div class="form-group">
              <label for="addSeatsAvailable">Seats Available</label>
              <input type="number" id="addSeatsAvailable" name="seats_available" min="1" required>
            </div>

            <div class="form-group">
              <label for="addRideType">Ride Type</label>
              <select id="addRideType" name="ride_type" required>
                <option value="Jeepney">Jeepney</option>
                <option value="Service">Service</option>
              </select>
            </div>

            <div class="button-group">
              <button type="submit" id="addRideButton">Add Ride</button>
              <button type="button" onclick="closeAddRideModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Setup drag and drop
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');

      if (dropZone && fileInput) {
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
          handleFile(e.target.files[0]);
        });
      }

      // Add click handler for select button
      const selectButton = document.getElementById('selectButton');
      if (selectButton) {
        selectButton.addEventListener('click', UploadSuccessMessage);
      }
    });

    let allRides = [];  // Store all fetched rides

    // Fetch data for rides
    async function fetchData() {
      try {
        const ridesResponse = await fetch('/api/rides'); 
        if (!ridesResponse.ok) {
          throw new Error('Failed to fetch rides');
        }
        const rides = await ridesResponse.json();
        allRides = rides;
        displayRides(rides);
        populateFilters(rides);  // Populate the filter options
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('rides-container').innerHTML = `<p>Failed to load rides data.</p>`;
      }
    }

    // Display rides
    function displayRides(rides) {
      const ridesContainer = document.getElementById('rides-container');
      ridesContainer.innerHTML = ''; // Clear the container

      if (rides.length === 0) {
        ridesContainer.innerHTML = `<p style="color: gray;">Sorry ü•≤ There are no current rides available with the information you are looking for ü•≤</p>`;
        return;
      }

      rides.forEach(ride => {
        const rideItem = document.createElement('div');
        rideItem.className = 'ride-item';
        rideItem.innerHTML = `
          <p>${ride.ride_id}</p>
          <p>${ride.plate_number}</p>
          <div class="image-container">
            <img src="./assets/Vehicle_Default.png" alt="Image">
            <div class="image-buttons">
              <button onclick="previewImage('./assets/Vehicle_Default.png')" class="preview-btn">Preview</button>
              <button onclick="replaceImage(${ride.ride_id})" class="replace-btn">Replace</button>
            </div>
          </div>
          <p>${ride.route}</p>
          <p>${new Date(ride.departure).toLocaleString()}</p>
          <p>${ride.seats_available}</p>
          <button onclick="editRide(${ride.ride_id})" class="edit-btn">Edit</button>
        `;
        ridesContainer.appendChild(rideItem);
      });
    }

    // Filter rides based on search input
    function filterRides() {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const filteredRides = allRides.filter(ride => {
        return (
          ride.ride_id.toString().includes(searchInput) ||
          ride.plate_number.toLowerCase().includes(searchInput) ||
          ride.route.toLowerCase().includes(searchInput) ||
          ride.seats_available.toString().includes(searchInput)
        );
      });
      displayRides(filteredRides);
    }

    // Apply filters to the rides
    function applyFilters() {
      const plateNumber = document.getElementById('filterPlateNumber').value.toLowerCase();
      const route = document.getElementById('filterRoute').value.toLowerCase();
      const departure = document.getElementById('filterDeparture').value.toLowerCase();
      const seatsAvailable = document.getElementById('filterSeatsAvailable').value.toLowerCase();

      const filteredRides = allRides.filter(ride => {
        return (
          (plateNumber === "" || ride.ride_id.toString().includes(plateNumber)) &&
          (route === "" || ride.route.toLowerCase().includes(route)) &&
          (departure === "" || new Date(ride.departure).toLocaleDateString().includes(departure)) &&
          (seatsAvailable === "" || ride.seats_available.toString().includes(seatsAvailable))
        );
      });

      displayRides(filteredRides);
    }

    // Clear all filters
    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterPlateNumber').value = '';
      document.getElementById('filterRoute').value = '';
      document.getElementById('filterDeparture').value = '';
      document.getElementById('filterSeatsAvailable').value = '';
      displayRides(allRides);
    }

    // Populate filter dropdowns with dynamic values
    function populateFilters(rides) {
      const plateNumbers = [...new Set(rides.map(ride => ride.ride_id.toString()))];
      const routes = [...new Set(rides.map(ride => ride.route))];
      const departureDates = [...new Set(rides.map(ride => new Date(ride.departure).toLocaleDateString()))];
      const seatsAvailableOptions = [...new Set(rides.map(ride => ride.seats_available.toString()))];

      populateDropdown('filterPlateNumber', plateNumbers);
      populateDropdown('filterRoute', routes);
      populateDropdown('filterDeparture', departureDates);
      populateDropdown('filterSeatsAvailable', seatsAvailableOptions);
    }

    // Helper function to populate dropdown options
    function populateDropdown(selectId, options) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">All</option>';
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });
    }
    
        // Show Add Ride Modal
        function showAddRideModal() {
      // Code for showing the modal (if required)
      console.log("Show Add Ride Modal functionality");
    }

    // Update Ride
    function updateRide() {
      // Code for updating the ride in the database
    }

    // Delete Ride
    async function deleteRide(rideId) {
      const response = await fetch(`/routes/rides/${rideId}`, {
        method: 'DELETE',
      });
      if (response.ok) {
        fetchRides();
      }
    }
    
    // Download rides data as CSV
    async function downloadRidesCSV() {
      const rides = allRides;
      const csvRows = [
        ['Ride ID', 'Plate Number', 'Route', 'Seats Available', 'Departure', 'Image'],
        ...rides.map(ride => [
          ride.ride_id,
          ride.plate_number,
          ride.route,
          ride.seats_available,
          new Date(ride.departure).toLocaleString(),
          ride.image_url,
        ]),
      ];

      const csvContent = csvRows.map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'rides.csv';
      link.click();
    }

    // Fetch data when the page loads
    fetchData();

    let currentEditRideId = null;

    function editRide(rideId) {
      currentEditRideId = rideId;
      const ride = allRides.find(r => r.ride_id === rideId);
      
      // Populate the form with current values
      document.getElementById('editPlateNumber').value = ride.plate_number;
      document.getElementById('editRoute').value = ride.route;
      document.getElementById('editDeparture').value = new Date(ride.departure).toISOString().slice(0, 16);
      document.getElementById('editSeatsAvailable').value = ride.seats_available;
      
      // Show the modal
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditRideId = null;
      // Reset form
      document.getElementById('editRideForm').reset();
    }

    function previewImage(imageUrl) {
      const previewImg = document.getElementById('previewImage');
      previewImg.src = imageUrl || '/images/default-vehicle.jpg';
      document.getElementById('imagePreviewModal').style.display = 'block';
    }

    function closeImagePreview() {
      document.getElementById('imagePreviewModal').style.display = 'none';
    }

    let selectedFile = null;

    function replaceImage(rideId) {
      const modal = document.getElementById('uploadImageModal');
      if (!modal) {
        console.error('Upload modal not found');
        return;
      }
      
      // Store rideId for later use
      modal.dataset.rideId = rideId;
      
      // Reset upload state
      const uploadStatus = document.getElementById('uploadStatus');
      const fileInfo = document.getElementById('fileInfo');
      const selectButton = document.getElementById('selectButton');
      
      if (uploadStatus) uploadStatus.textContent = '';
      if (fileInfo) fileInfo.textContent = '';
      if (selectButton) selectButton.disabled = true;
      
      // Show the modal
      modal.style.display = 'block';
    }

    function handleFile(file) {
      const maxSize = 6 * 1024 * 1024; // 6MB
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
      const statusDiv = document.getElementById('uploadStatus');
      const fileInfoDiv = document.getElementById('fileInfo');
      const selectButton = document.getElementById('selectButton');
      
      // Validate file
      if (!file) return;
      
      if (!allowedTypes.includes(file.type)) {
        statusDiv.innerHTML = '<span class="error-message">Error: Only JPEG, JPG, and PNG files are allowed.</span>';
        selectButton.disabled = true;
        return;
      }
      
      if (file.size > maxSize) {
        statusDiv.innerHTML = '<span class="error-message">Error: File size must be less than 6MB.</span>';
        selectButton.disabled = true;
        return;
      }
      
      // File is valid
      selectedFile = file;
      statusDiv.textContent = 'File ready for upload';
      
      // Get ride details for filename preview
      const modal = document.getElementById('uploadImageModal');
      const rideId = modal.dataset.rideId;
      const ride = allRides.find(r => r.ride_id === parseInt(rideId));
      const fileExtension = file.name.split('.').pop();
      const newFileName = `${ride.ride_id}_${ride.route}.${fileExtension}`;
      
      fileInfoDiv.textContent = `This file will be renamed as: ${newFileName}`;
      selectButton.disabled = false;
    }

    function UploadSuccessMessage() {
      // Create the popup element
      const popup = document.createElement('div');
      popup.className = 'success-popup';
      popup.innerHTML = 'Image updated ! ‚úÖ';
      document.body.appendChild(popup);

      // Add styles for the popup
      popup.style.position = 'fixed';
      popup.style.top = '20px';
      popup.style.right = '20px';
      popup.style.backgroundColor = '#34A853';
      popup.style.color = 'white';
      popup.style.padding = '15px 25px';
      popup.style.borderRadius = '5px';
      popup.style.zIndex = '1000';
      popup.style.animation = 'slideIn 0.5s ease-out';

      // Add animation keyframes
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }
      `;
      document.head.appendChild(style);

      // Remove the popup after 3 seconds
      setTimeout(() => {
        popup.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => {
          document.body.removeChild(popup);
        }, 500);
      }, 3000);
    }

    // Update the handleFileUpload function
    async function handleFileUpload() {
      if (!selectedFile) return;
      
      const modal = document.getElementById('uploadImageModal');
      const rideId = modal.dataset.rideId;
      const ride = allRides.find(r => r.ride_id === parseInt(rideId));
      
      const formData = new FormData();
      formData.append('image', selectedFile);
      formData.append('ride_id', rideId);
      formData.append('route', ride.route);
      
      try {
        const response = await fetch('http://gomingo:5000/api/rides/update-image', {
          method: 'POST',
          body: formData
        });
        
        let data;
        try {
          data = await response.json();
        } catch (e) {
          throw new Error('Invalid response from server');
        }

        if (!response.ok) {
          throw new Error(data.error || 'Failed to upload image');
        }

        // Update the image in the ride row
        const rideImage = document.querySelector(`.ride-item img[data-ride-id="${rideId}"]`);
        if (rideImage) {
          rideImage.src = './assets/jeep.jpg';
        }

        // Show success message popup
        UploadSuccessMessage();
        closeUploadImageModal();
        
      } catch (error) {
        console.error('Error uploading image:', error);
        alert(`Failed to upload image: ${error.message}`);
      }
    }

    function closeUploadImageModal() {
      const modal = document.getElementById('uploadImageModal');
      if (modal) {
        modal.style.display = 'none';
        selectedFile = null;
        const fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.value = '';
        const uploadStatus = document.getElementById('uploadStatus');
        if (uploadStatus) uploadStatus.textContent = '';
        const fileInfo = document.getElementById('fileInfo');
        if (fileInfo) fileInfo.textContent = '';
        const selectButton = document.getElementById('selectButton');
        if (selectButton) selectButton.disabled = true;
      }
    }

    // Update the form submission handler
    document.getElementById('editRideForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const updatedRide = {
        ride_id: currentEditRideId, // Add the ride_id
        plate_number: document.getElementById('editPlateNumber').value,
        route: document.getElementById('editRoute').value,
        departure: document.getElementById('editDeparture').value,
        seats_available: parseInt(document.getElementById('editSeatsAvailable').value)
      };

      try {
        const response = await fetch(`/api/rides/${currentEditRideId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedRide)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Update successful:', result);
          alert('Ride updated successfully!');
          closeEditModal();
          await fetchData(); // Refresh the ride list
        } else {
          const error = await response.json();
          throw new Error(error.message || 'Failed to update ride');
        }
      } catch (error) {
        console.error('Error updating ride:', error);
        alert('Failed to update ride: ' + error.message);
      }
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
      const editModal = document.getElementById('editModal');
      const imagePreviewModal = document.getElementById('imagePreviewModal');
      if (event.target === editModal) {
        closeEditModal();
      }
      if (event.target === imagePreviewModal) {
        closeImagePreview();
      }
    }

    function closeAddModal() {
      if (document.getElementById('addRideForm').hasChanged) {
        confirmCancel('add');
      } else {
        document.getElementById('addRideModal').style.display = 'none';
      }
    }

    // Window control functions
    function minimizeModal(modalId) {
      const modalContent = document.querySelector(`#${modalId} .modal-content`);
      modalContent.classList.toggle('minimized');
      if (modalContent.classList.contains('maximized')) {
        modalContent.classList.remove('maximized');
      }
    }

    function maximizeModal(modalId) {
      const modalContent = document.querySelector(`#${modalId} .modal-content`);
      modalContent.classList.toggle('maximized');
      if (modalContent.classList.contains('minimized')) {
        modalContent.classList.remove('minimized');
      }
    }

    // Update existing close functions
    function closeAddModal() {
      if (document.getElementById('addRideForm').hasChanged) {
        confirmCancel('add');
      } else {
        const modal = document.getElementById('addRideModal');
        const modalContent = modal.querySelector('.modal-content');
        modalContent.classList.remove('minimized', 'maximized');
        modal.style.display = 'none';
      }
    }

    function closeUploadModal() {
      const modal = document.getElementById('uploadModal');
      const modalContent = modal.querySelector('.modal-content');
      modalContent.classList.remove('minimized', 'maximized');
      modal.style.display = 'none';
      selectedFile = null;
      document.getElementById('uploadMessage').textContent = '';
    }

    function closeEditModal() {
      const modal = document.getElementById('editModal');
      const modalContent = modal.querySelector('.modal-content');
      modalContent.classList.remove('minimized', 'maximized');
      modal.style.display = 'none';
      currentEditRideId = null;
    }

    // Add event listener for the select button
    document.addEventListener('DOMContentLoaded', function() {
      const selectButton = document.getElementById('selectButton');
      if (selectButton) {
        selectButton.addEventListener('click', handleFileUpload);
      }
    });

    // Update the toggleAddRideMode function
    function toggleAddRideMode() {
      document.getElementById('addRideModal').style.display = 'block';
    }

    // Add new modal control functions
    function closeAddRideModal() {
      const modal = document.getElementById('addRideModal');
      const modalContent = modal.querySelector('.modal-content');
      modalContent.classList.remove('minimized', 'maximized');
      modal.style.display = 'none';
      document.getElementById('addRideForm').reset();
    }

    // Add form submission handler
    document.getElementById('addRideForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        plate_number: document.getElementById('addPlateNumber').value,
        route: document.getElementById('addRoute').value,
        departure: document.getElementById('addDeparture').value,
        seats_available: document.getElementById('addSeatsAvailable').value,
        ride_type: document.getElementById('addRideType').value
      };

      try {
        const response = await fetch('/api/rides', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          throw new Error('Failed to add ride');
        }

        // Show success message
        alert('Ride added successfully!');
        
        // Close modal and refresh rides
        closeAddRideModal();
        fetchData();
        
      } catch (error) {
        console.error('Error adding ride:', error);
        alert('Failed to add ride: ' + error.message);
      }
    });

    function toggleDeleteMode() {
      const deleteModal = document.getElementById('deleteRideModal');
      if (deleteModal) {
        deleteModal.style.display = 'block';
      }
    }

    function exitDeleteMode() {
      const deleteModal = document.getElementById('deleteRideModal');
      if (deleteModal) {
        deleteModal.style.display = 'none';
        // Clear any selected checkboxes
        const checkboxes = document.querySelectorAll('input[name="rideSelect"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
        document.getElementById('selectAll').checked = false;
        // Hide error message if it was showing
        document.querySelector('.error-message').style.display = 'none';
      }
    }

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('input[name="rideSelect"]');
      checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
    }

    function confirmDelete() {
      const selectedCheckboxes = document.querySelectorAll('input[name="rideSelect"]:checked');
      if (selectedCheckboxes.length === 0) {
        document.querySelector('.error-message').style.display = 'block';
        return;
      }
      
      const confirmModal = document.getElementById('confirmDeleteModal');
      if (confirmModal) {
        confirmModal.style.display = 'block';
      }
    }

    function closeConfirmModal() {
      const confirmModal = document.getElementById('confirmDeleteModal');
      if (confirmModal) {
        confirmModal.style.display = 'none';
      }
    }

    function executeDelete() {
      const selectedCheckboxes = document.querySelectorAll('input[name="rideSelect"]:checked');
      const deletedCount = selectedCheckboxes.length;
      
      // Update the count in the success modal
      document.getElementById('deletedCount').textContent = deletedCount;
      
      // Hide confirm modal and show success modal
      closeConfirmModal();
      const successModal = document.getElementById('successModal');
      if (successModal) {
        successModal.style.display = 'block';
      }
    }

    function closeSuccessModal() {
      const successModal = document.getElementById('successModal');
      if (successModal) {
        successModal.style.display = 'none';
        exitDeleteMode(); // Return to normal mode
      }
    }
  </script>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('editModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('editModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="closeEditModal()">√ó</button>
      </div>
      <h2>Edit Ride</h2>
      <form id="editRideForm">
        <div class="form-group">
          <label for="editPlateNumber">Plate Number:</label>
          <input type="text" id="editPlateNumber" required>
        </div>
        <div class="form-group">
          <label for="editRoute">Route:</label>
          <input type="text" id="editRoute" required>
        </div>
        <div class="form-group">
          <label for="editDeparture">Departure:</label>
          <input type="datetime-local" id="editDeparture" required>
        </div>
        <div class="form-group">
          <label for="editSeatsAvailable">Seats Available:</label>
          <input type="number" id="editSeatsAvailable" required>
        </div>
        <div class="button-group">
          <button type="submit" class="save-btn">Save</button>
          <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="imagePreviewModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('imagePreviewModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('imagePreviewModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="closeImagePreview()">√ó</button>
      </div>
      <img id="previewImage" src="" alt="Preview" style="max-width: 100%;">
    </div>
  </div>

  <!-- Add Ride Modal -->
  <div id="addRideModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('addRideModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('addRideModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="closeAddRideModal()">√ó</button>
      </div>
      <h2>Add New Ride</h2>
      <!-- rest of the add ride form content -->
    </div>
  </div>

  <!-- Upload Image Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('uploadModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('uploadModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="closeUploadModal()">√ó</button>
      </div>
      <h2>Upload Image</h2>
      <!-- rest of the upload modal content -->
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeConfirmModal()">&times;</span>
      <h2>Discard Changes?</h2>
      <!-- rest of the confirmation modal content -->
    </div>
  </div>

  <!-- Upload Image Modal -->
  <div id="uploadImageModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('uploadImageModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('uploadImageModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="closeUploadImageModal()">√ó</button>
      </div>
      
      <div class="upload-area" id="dropZone">
        <div class="upload-message">
          Upload from device or drag your image here üìÅ
        </div>
        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png" hidden>
        <div id="uploadStatus" class="upload-status"></div>
        <div id="fileInfo" class="file-info"></div>
      </div>
      
      <div class="modal-buttons">
        <button id="selectButton" class="select-btn" disabled>Select</button>
        <button class="cancel-btn" onclick="closeUploadImageModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add this modal for delete mode -->
  <div id="deleteRideModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('deleteRideModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('deleteRideModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="exitDeleteMode()">√ó</button>
      </div>
      <h2>Delete Rides</h2>
      <p class="delete-instructions">Select the rides you want to delete:</p>
      
      <!-- Example of how the rides list will look in delete mode -->
      <div class="ride-item header">
        <p><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></p>
        <p>Ride ID</p>
        <p>Plate Number</p>
        <p>Route</p>
        <p>Departure</p>
        <p>Seats Available</p>
      </div>
      <div id="delete-rides-container">
        <div class="ride-item">
          <p><input type="checkbox" name="rideSelect" value="1"></p>
          <p>1</p>
          <p>ABC123</p>
          <p>Bakakeng - Main</p>
          <p>2024-12-19 01:40:38</p>
          <p>23</p>
        </div>
        <div class="ride-item">
          <p><input type="checkbox" name="rideSelect" value="2"></p>
          <p>2</p>
          <p>ABC124</p>
          <p>Main - Bakakeng</p>
          <p>2024-12-19 02:10:00</p>
          <p>23</p>
        </div>
        <div class="ride-item">
          <p><input type="checkbox" name="rideSelect" value="3"></p>
          <p>3</p>
          <p>ABC125</p>
          <p>Bakakeng - Igorot Park</p>
          <p>2024-12-19 04:40:00</p>
          <p>15</p>
        </div>
        <div class="ride-item">
          <p><input type="checkbox" name="rideSelect" value="4"></p>
          <p>4</p>
          <p>ABC126</p>
          <p>Igorot Park - Bakakeng</p>
          <p>2024-12-19 06:10:00</p>
          <p>15</p>
        </div>
        <div class="ride-item">
          <p><input type="checkbox" name="rideSelect" value="5"></p>
          <p>5</p>
          <p>ABC128</p>
          <p>Bakakeng - Igorot Park</p>
          <p>2024-12-19 05:40:00</p>
          <p>23</p>
        </div>
        <div class="ride-item">
          <p><input type="checkbox" name="rideSelect" value="6"></p>
          <p>6</p>
          <p>ABC127</p>
          <p>Igorot Park - Bakakeng</p>
          <p>2024-12-19 06:00:00</p>
          <p>23</p>
        </div>
        <div class="ride-item">
          <p><input type="checkbox" name="rideSelect" value="7"></p>
          <p>7</p>
          <p>CDE1</p>
          <p>Igorot Park - Aquatics</p>
          <p>2024-12-14 09:20:00</p>
          <p>23</p>
        </div>
      </div>

      <div class="error-message" style="display: none; color: #c73421; margin: 10px 0;">
        Please select at least one ride to delete! ü•≤
      </div>

      <div class="button-group">
        <button type="button" class="delete-btn" onclick="confirmDelete()">Delete Selected</button>
        <button type="button" onclick="exitDeleteMode()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add confirmation modal -->
  <div id="confirmDeleteModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control close-btn" title="Close" onclick="closeConfirmModal()">√ó</button>
      </div>
      <h3>Confirm Deletion</h3>
      <p>Are you sure you want to delete the selected rides?</p>
      <div class="button-group">
        <button type="button" onclick="executeDelete()">Yes</button>
        <button type="button" onclick="closeConfirmModal()">No</button>
      </div>
    </div>
  </div>

  <!-- Add success message modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control close-btn" title="Close" onclick="closeSuccessModal()">√ó</button>
      </div>
      <h3>Success!</h3>
      <p>Deleted <span id="deletedCount">0</span> rows Successfully ü•≤</p>
      <div class="button-group">
        <button type="button" onclick="closeSuccessModal()">OK</button>
      </div>
    </div>
  </div>
</body>
</html>
