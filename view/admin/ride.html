<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoGora - Ride Management</title>
  <link rel="stylesheet" href="admin.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Markazi+Text:wght@400..700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/assets/favicon.png">
  <script src="/api/ride_editor.js"></script>
  <script src="/api/ride_editor.js"></script>

  <style>
    /* Ride-specific styles */
    .image-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .image-buttons {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .window-controls {
      position: absolute;
      right: 10px;
      top: 10px;
      display: flex;
      gap: 8px;
    }

    .window-control {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      color: rgb(255, 255, 255);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .minimize {
      background-color: #edd132;
      color: black;
    }
    
    .maximize {
      background-color: #34A853;
      color: black;
    }
    
    .close-btn {
      background-color: #c73421;
      color: black;
    }

    .window-control:hover {
      opacity: 0.8;
    }

    .modal-content.minimized {
      transform: scale(0.7);
      width: 70%;
      margin-top: 80vh;
      opacity: 0.8;
    }

    .modal-content.maximized {
      width: 95vw;
      max-width: none;
      height: 90vh;
      margin: 5vh auto;
    }

    #imagePreviewModal .modal-content {
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      min-height: 400px;
    }

    #previewImage {
      max-width: 90%;
      max-height: 80vh;
      object-fit: contain;
      margin: auto;
      display: block;
    }

    /* Adjust the window controls to stay at the top */
    #imagePreviewModal .window-controls {
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 1001;

      padding: 5px;
    }

    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      margin: 20px;
      min-height: 200px;
      position: relative;
    }

    .upload-area.drag-over {
      border-color: #4285F4;
      background: rgba(66, 133, 244, 0.1);
    }

    .upload-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 15px;
    }

    .upload-status {
      margin-top: 15px;
      color: #666;
    }

    .file-info {
      margin-top: 10px;
      font-size: 14px;
      color: #4285F4;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 15px;
    }

    .select-btn {
      background: #4285F4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .select-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .error-message {
      color: #c73421;
      margin-top: 10px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;  /* Space between buttons */
      align-items: center;
    }

    .add-ride, .delete-ride, .download-csv {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      color: white;
    }

    .download-csv {
      background-color: #4285F4;
      color: white;
    }

    .add-ride:hover, .delete-ride:hover, .download-csv:hover {
      opacity: 0.9;
    }
    .add-ride:hover, .delete-ride:hover{
      background-color: #0A3981;
    }

    /* Add these styles to your existing style section */
    
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .save-btn {
      background-color: #4285F4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .save-btn:hover {
      background-color: #3367D6;
    }

    .cancel-btn {
      background-color: #757575;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .cancel-btn:hover {
      background-color: #616161;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .success-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #34A853;
      color: white;
      padding: 15px 25px;
      border-radius: 5px;
      z-index: 1000;
      animation: slideIn 0.5s ease-out;
    }

    .checkbox-column {
      width: 30px;
      text-align: center;
      display: none;
    }

    .checkbox-column.show {
      display: table-cell;
    }

    .delete-mode-controls {
      display: none;
      margin: 10px 0;
      gap: 10px;
    }

    .delete-mode-controls.show {
      display: flex;
    }

    .delete-mode-controls button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .confirm-delete {
      background-color: #EA4335;
      color: white;
    }

    .cancel-delete {
      background-color: #757575;
      color: white;
    }

    .error-message {
      color: #EA4335;
      margin: 10px 0;
      display: none;
    }

    .delete-mode-controls {
      margin: 10px 0;
      gap: 10px;
      align-items: center;
    }

    .confirm-delete {
      background-color: #EA4335;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .cancel-delete {
      background-color: #757575;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .error-message {
      color: #EA4335;
      margin-left: 10px;
      display: none;
    }

    .ride-checkbox {
      margin-right: 10px;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .delete-content {
      padding: 20px;
    }

    .delete-ride-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .delete-ride-item:last-child {
      border-bottom: none;
    }

    .delete-ride-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .confirm-delete {
      background-color: #EA4335;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .cancel-delete {
      background-color: #757575;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    #deleteRidesList {
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
      border: 1px solid #eee;
      border-radius: 4px;
    }

    /* Add these styles to your existing style section */
    
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .save-btn {
      background-color: #4285F4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .save-btn:hover {
      background-color: #3367D6;
    }

    .cancel-btn {
      background-color: #757575;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .cancel-btn:hover {
      background-color: #616161;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .success-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #34A853;
      color: white;
      padding: 15px 25px;
      border-radius: 5px;
      z-index: 1000;
      animation: slideIn 0.5s ease-out;
    }

    .checkbox-column {
      width: 30px;
      text-align: center;
      display: none;
    }

    .checkbox-column.show {
      display: table-cell;
    }

    .delete-mode-controls {
      display: none;
      margin: 10px 0;
      gap: 10px;
    }

    .delete-mode-controls.show {
      display: flex;
    }

    .delete-mode-controls button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .confirm-delete {
      background-color: #EA4335;
      color: white;
    }

    .cancel-delete {
      background-color: #757575;
      color: white;
    }

    .error-message {
      color: #EA4335;
      margin: 10px 0;
      display: none;
    }

    .delete-mode-controls {
      margin: 10px 0;
      gap: 10px;
      align-items: center;
    }

    .confirm-delete {
      background-color: #EA4335;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .cancel-delete {
      background-color: #757575;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .error-message {
      color: #EA4335;
      margin-left: 10px;
      display: none;
    }

    .ride-checkbox {
      margin-right: 10px;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .delete-content {
      padding: 20px;
    }

    .delete-ride-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .delete-ride-item:last-child {
      border-bottom: none;
    }

    .delete-ride-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .confirm-delete {
      background-color: #EA4335;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .cancel-delete {
      background-color: #757575;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    #deleteRidesList {
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
      border: 1px solid #eee;
      border-radius: 4px;
    }

  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="logo">
        <h2><span style="color: #4285F4;">Go</span><span style="color: #FBBC05;">Go</span><span style="color: #FBBC05;">Ra</span></h2>
      </div>
      <nav>
        <ul class="menu">
          <li><a href="index.html" class="menu-item"><i class="icon">🏠</i> Dashboard</a></li>
          <li><a href="ride_manager.html" class="menu-item"><i class="icon">🛣️</i> Manage Rides</a>
            <a href="ride.html" class="menu-item" style="padding-left: 45px;"><i class="icon">🚖</i> Rides</a>
            <a href="schedules.html" class="menu-item" style="padding-left: 45px;"><i class="icon">📅</i> Schedules</a>
          </li>
          <li><a href="account_manager.html" class="menu-item"><i class="icon">👥</i> Manage Accounts</a></li>
          <li><a href="statistics.html" class="menu-item"><i class="icon">📊</i> Statistics</a></li>
          <li><a href="blacklist.html" class="menu-item"><i class="icon">🚫</i> Blacklist Passengers</a></li>
        </ul>
      </nav>
    </aside>
    <main class="main-content">
      <div class="title-section">
        <h1>Manage Rides</h1>
      </div>

      <div class="search-filters">
        <h3> Search:</h3>
        <input type="text" id="searchInput" placeholder="Search Rides" oninput="filterRides()">
        <h3> Ride ID:</h3>
        <select id="filterPlateNumber">
          <option value="">Filter by Ride ID</option>
        </select>
          <h3> Route:</h3>
        <select id="filterRoute">
          <option value="">Filter by Route</option>
        </select>
          <h3> Departure:</h3>
        <select id="filterDeparture">
          <option value="">Filter by Departure</option>
        </select>
        <h3> Capacity: </h3>
        <select id="filterCapacity">
          <option value="">Filter by Capacity</option>
        <h3> Capacity: </h3>
        <select id="filterCapacity">
          <option value="">Filter by Capacity</option>
        </select>
        <button onclick="applyFilters()">Apply</button>
        <button onclick="clearFilters()">Clear All</button>
      </div>

      <div class="rides-section">
        <div class="header-buttons-container">
          <h2>Rides</h2>
          <div class="action-buttons">
            <button class="add-ride" onclick="toggleAddRideMode()">Add Ride</button>
            <button class="delete-ride" onclick="toggleDeleteMode()">Delete Ride</button>
            <button class="download-csv" onclick="downloadRidesCSV()">Download CSV</button>
          </div>
        </div>
        <div class="delete-mode-controls" style="display: none;">
          <button class="confirm-delete" onclick="confirmDelete()">Delete Selected</button>
          <button class="cancel-delete" onclick="exitDeleteMode()">Cancel</button>
          <div class="error-message">Please select at least one ride to delete.</div>
        </div>
        <div class="delete-mode-controls" style="display: none;">
          <button class="confirm-delete" onclick="confirmDelete()">Delete Selected</button>
          <button class="cancel-delete" onclick="exitDeleteMode()">Cancel</button>
          <div class="error-message">Please select at least one ride to delete.</div>
        </div>
        <div class="ride-item header">
          <p>Ride ID</p>
          <p>Plate Number</p>
          <p>Image</p>
          <p>Route</p>
          <p>Departure</p>
          <p>Capacity</p>
          <p>Capacity</p>
        </div>
        <div id="rides-container">
          <!-- Ride items will be populated dynamically here -->
        </div>
      </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Setup drag and drop
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');

      if (dropZone && fileInput) {
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
          handleFile(e.target.files[0]);
        });
      }

      // Add click handler for select button
      const selectButton = document.getElementById('selectButton');
      if (selectButton) {
        selectButton.addEventListener('click', UploadSuccessMessage);
      }
    });

    let allRides = [];  // Store all fetched rides

    // Fetch data for rides
    async function fetchData() {
      try {
        const ridesResponse = await fetch('/api/rides'); 
        if (!ridesResponse.ok) {
          throw new Error('Failed to fetch rides');
        }
        const rides = await ridesResponse.json();
        allRides = rides;
        displayRides(rides);
        populateFilters(rides);  // Populate the filter options
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('rides-container').innerHTML = `<p>Failed to load rides data.</p>`;
      }
    }

    // Display rides
    function displayRides(rides) {
      const ridesContainer = document.getElementById('rides-container');
      ridesContainer.innerHTML = '';
      ridesContainer.innerHTML = '';

      if (rides.length === 0) {
        ridesContainer.innerHTML = `<p style="color: gray;">Sorry 🥲 There are no current rides available with the information you are looking for 🥲</p>`;
        return;
      }

      rides.forEach(ride => {
        const rideItem = document.createElement('div');
        rideItem.className = 'ride-item';
        const imagePath = ride.image_path || './assets/Vehicle_Default.png';
        
        const imagePath = ride.image_path || './assets/Vehicle_Default.png';
        
        rideItem.innerHTML = `
          <p>${ride.ride_id}</p>
          <p>${ride.plate_number}</p>
          <div class="image-container">
            <img src="${imagePath}" alt="Image" id="ride-image-${ride.ride_id}">
            <img src="${imagePath}" alt="Image" id="ride-image-${ride.ride_id}">
            <div class="image-buttons">
              <button onclick="previewImage('${imagePath}')" class="preview-btn">Preview</button>
              <button onclick="previewImage('${imagePath}')" class="preview-btn">Preview</button>
              <button onclick="replaceImage(${ride.ride_id})" class="replace-btn">Replace</button>
            </div>
          </div>
          <p>${ride.route}</p>
          <p>${new Date(ride.departure).toLocaleString()}</p>
          <p>${ride.capacity}</p>
          <p>${ride.capacity}</p>
          <button onclick="editRide(${ride.ride_id})" class="edit-btn">Edit</button>
        `;
        ridesContainer.appendChild(rideItem);
      });
    }

    // Filter rides based on search input
    function filterRides() {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const filteredRides = allRides.filter(ride => {
        return (
          ride.ride_id.toString().includes(searchInput) ||
          ride.plate_number.toLowerCase().includes(searchInput) ||
          ride.route.toLowerCase().includes(searchInput) ||
          ride.capacity.toString().includes(searchInput)
          ride.capacity.toString().includes(searchInput)
        );
      });
      displayRides(filteredRides);
    }

    // Apply filters to the rides
    function applyFilters() {
      const plateNumber = document.getElementById('filterPlateNumber').value.toLowerCase();
      const route = document.getElementById('filterRoute').value.toLowerCase();
      const departure = document.getElementById('filterDeparture').value.toLowerCase();
      const capacity= document.getElementById('filterCapacity').value.toLowerCase();
      const capacity= document.getElementById('filterCapacity').value.toLowerCase();

      const filteredRides = allRides.filter(ride => {
        return (
          (plateNumber === "" || ride.ride_id.toString().includes(plateNumber)) &&
          (route === "" || ride.route.toLowerCase().includes(route)) &&
          (departure === "" || new Date(ride.departure).toLocaleDateString().includes(departure)) &&
          (capacity === "" || ride.capacity.toString().includes(capacity))
          (capacity === "" || ride.capacity.toString().includes(capacity))
        );
      });

      displayRides(filteredRides);
    }

    // Clear all filters
    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterPlateNumber').value = '';
      document.getElementById('filterRoute').value = '';
      document.getElementById('filterDeparture').value = '';
      document.getElementById('filterCapacity').value = '';
      document.getElementById('filterCapacity').value = '';
      displayRides(allRides);
    }

    // Populate filter dropdowns with dynamic values
    function populateFilters(rides) {
      const plateNumbers = [...new Set(rides.map(ride => ride.ride_id.toString()))];
      const routes = [...new Set(rides.map(ride => ride.route))];
      const departureDates = [...new Set(rides.map(ride => new Date(ride.departure).toLocaleDateString()))];
      const capacityOptions= [...new Set(rides.map(ride => ride.capacity.toString()))];
      const capacityOptions= [...new Set(rides.map(ride => ride.capacity.toString()))];

      populateDropdown('filterPlateNumber', plateNumbers);
      populateDropdown('filterRoute', routes);
      populateDropdown('filterDeparture', departureDates);
      populateDropdown('filterCapacity', capacityOptions);
      populateDropdown('filterCapacity', capacityOptions);
    }

    // Helper function to populate dropdown options
    function populateDropdown(selectId, options) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">All</option>';
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });
    }
    
        // Show Add Ride Modal
        function showAddRideModal() {
      // Code for showing the modal (if required)
      console.log("Show Add Ride Modal functionality");
    }

    // Update Ride
    function updateRide() {
      // Code for updating the ride in the database
    }

    // Delete Ride
    async function deleteRide(rideId) {
      const response = await fetch(`/routes/rides/${rideId}`, {
        method: 'DELETE',
      });
      if (response.ok) {
        fetchRides();
      }
    }
    
    // Download rides data as CSV
    async function downloadRidesCSV() {
      const rides = allRides;
      const csvRows = [
        ['Ride ID', 'Plate Number', 'Route', 'Capacity', 'Departure', 'Image'],
        ['Ride ID', 'Plate Number', 'Route', 'Capacity', 'Departure', 'Image'],
        ...rides.map(ride => [
          ride.ride_id,
          ride.plate_number,
          ride.route,
          ride.capacity,
          ride.capacity,
          new Date(ride.departure).toLocaleString(),
          ride.image_url,
        ]),
      ];

      const csvContent = csvRows.map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'rides.csv';
      link.click();
    }

    // Fetch data when the page loads
    fetchData();

    let currentEditRideId = null;

    function editRide(rideId) {
      currentEditRideId = rideId;
      const ride = allRides.find(r => r.ride_id === rideId);
      
      // Populate the form with current values
      document.getElementById('editPlateNumber').value = ride.plate_number;
      document.getElementById('editRoute').value = ride.route;
      document.getElementById('editDeparture').value = new Date(ride.departure).toISOString().slice(0, 16);
      document.getElementById('editCapacity').value = ride.capacity;
      document.getElementById('editCapacity').value = ride.capacity;
      
      // Show the modal
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditRideId = null;
      // Reset form
      document.getElementById('editRideForm').reset();
    }

    function previewImage(imageUrl) {
      const previewImg = document.getElementById('previewImage');
      previewImg.src = imageUrl || '/images/default-vehicle.jpg';
      document.getElementById('imagePreviewModal').style.display = 'block';
    }

    function closeImagePreview() {
      document.getElementById('imagePreviewModal').style.display = 'none';
    }

    let selectedFile = null;

    function replaceImage(rideId) {
      // First show the upload modal
      // First show the upload modal
      const modal = document.getElementById('uploadImageModal');
      modal.style.display = 'block';
      modal.dataset.rideId = rideId; // Store the ride ID for later use

      // Reset the upload form
      const fileInput = document.getElementById('fileInput');
      if (fileInput) fileInput.value = '';
      modal.style.display = 'block';
      modal.dataset.rideId = rideId; // Store the ride ID for later use

      // Reset the upload form
      const fileInput = document.getElementById('fileInput');
      if (fileInput) fileInput.value = '';
      const uploadStatus = document.getElementById('uploadStatus');
      if (uploadStatus) uploadStatus.textContent = '';
      const fileInfo = document.getElementById('fileInfo');
      const fileInfo = document.getElementById('fileInfo');
      if (fileInfo) fileInfo.textContent = '';
      const selectButton = document.getElementById('selectButton');
      const selectButton = document.getElementById('selectButton');
      if (selectButton) selectButton.disabled = true;
    }

    function handleFile(file) {
      const maxSize = 6 * 1024 * 1024; // 6MB
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
      const statusDiv = document.getElementById('uploadStatus');
      const fileInfoDiv = document.getElementById('fileInfo');
      const selectButton = document.getElementById('selectButton');
      
      // Validate file
      if (!file) return;
      
      if (!allowedTypes.includes(file.type)) {
        statusDiv.innerHTML = '<span class="error-message">Error: Only JPEG, JPG, and PNG files are allowed.</span>';
        selectButton.disabled = true;
        return;
      }
      
      if (file.size > maxSize) {
        statusDiv.innerHTML = '<span class="error-message">Error: File size must be less than 6MB.</span>';
        selectButton.disabled = true;
        return;
      }
      
      // File is valid
      selectedFile = file;
      statusDiv.textContent = 'File ready for upload';
      
      // Get ride details for filename preview
      const modal = document.getElementById('uploadImageModal');
      const rideId = modal.dataset.rideId;
      const ride = allRides.find(r => r.ride_id === parseInt(rideId));
      const fileExtension = file.name.split('.').pop();
      const newFileName = `${ride.plate_number}_image.${fileExtension}`;
      const newFileName = `${ride.plate_number}_image.${fileExtension}`;
      
      fileInfoDiv.textContent = `This file will be renamed as: ${newFileName}`;
      selectButton.disabled = false;
    }

    function handleFileUpload() {
      if (!selectedFile) return;
      
      const modal = document.getElementById('uploadImageModal');
      const rideId = modal.dataset.rideId;
      
      // Simulate upload delay
      setTimeout(() => {
        // Update only the specific ride's image to jeep.jpg
        const imageElement = document.getElementById(`ride-image-${rideId}`);
        if (imageElement) {
          imageElement.src = './assets/jeep.jpg';
        }
        
        // Show success message
        UploadSuccessMessage();
        
        // Close the upload modal
        closeUploadImageModal();
      }, 500); // Half second delay to simulate upload
    }

    function handleFileUpload() {
      if (!selectedFile) return;
      
      const modal = document.getElementById('uploadImageModal');
      const rideId = modal.dataset.rideId;
      
      // Simulate upload delay
      setTimeout(() => {
        // Update only the specific ride's image to jeep.jpg
        const imageElement = document.getElementById(`ride-image-${rideId}`);
        if (imageElement) {
          imageElement.src = './assets/jeep.jpg';
        }
        
        // Show success message
        UploadSuccessMessage();
        
        // Close the upload modal
        closeUploadImageModal();
      }, 500); // Half second delay to simulate upload
    }

    function UploadSuccessMessage() {
      // Create the popup element
      const popup = document.createElement('div');
      popup.className = 'success-popup';
      popup.innerHTML = 'Image updated ! ✅';
      document.body.appendChild(popup);

      // Add styles for the popup
      popup.style.position = 'fixed';
      popup.style.top = '20px';
      popup.style.right = '20px';
      popup.style.backgroundColor = '#34A853';
      popup.style.color = 'white';
      popup.style.padding = '15px 25px';
      popup.style.borderRadius = '5px';
      popup.style.zIndex = '1000';
      popup.style.animation = 'slideIn 0.5s ease-out';

      // Add animation keyframes
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }
      `;
      document.head.appendChild(style);

      // Remove the popup after 3 seconds
      setTimeout(() => {
        popup.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => {
          document.body.removeChild(popup);
        }, 500);
      }, 3000);
    }

    function closeUploadImageModal() {
      const modal = document.getElementById('uploadImageModal');
      if (modal) {
        modal.style.display = 'none';
        selectedFile = null;
        const fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.value = '';
        const uploadStatus = document.getElementById('uploadStatus');
        if (uploadStatus) uploadStatus.textContent = '';
        const fileInfo = document.getElementById('fileInfo');
        if (fileInfo) fileInfo.textContent = '';
        const selectButton = document.getElementById('selectButton');
        if (selectButton) selectButton.disabled = true;
      }
    }

    // Update the form submission handler
    document.getElementById('editRideForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const updatedRide = {
        ride_id: currentEditRideId, // Add the ride_id
        plate_number: document.getElementById('editPlateNumber').value,
        route: document.getElementById('editRoute').value,
        departure: document.getElementById('editDeparture').value,
        capacity: parseInt(document.getElementById('editCapacity').value)
        capacity: parseInt(document.getElementById('editCapacity').value)
      };

      try {
        const response = await fetch(`/api/rides/${currentEditRideId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedRide)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Update successful:', result);
          alert('Ride updated successfully!');
          closeEditModal();
          await fetchData(); // Refresh the ride list
        } else {
          const error = await response.json();
          throw new Error(error.message || 'Failed to update ride');
        }
      } catch (error) {
        console.error('Error updating ride:', error);
        alert('Failed to update ride: ' + error.message);
      }
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
      const editModal = document.getElementById('editModal');
      const imagePreviewModal = document.getElementById('imagePreviewModal');
      if (event.target === editModal) {
        closeEditModal();
      }
      if (event.target === imagePreviewModal) {
        closeImagePreview();
      }
    }

    function closeAddModal() {
      if (document.getElementById('addRideForm').hasChanged) {
        confirmCancel('add');
      } else {
        document.getElementById('addRideModal').style.display = 'none';
      }
    }

    // Window control functions
    function minimizeModal(modalId) {
      const modalContent = document.querySelector(`#${modalId} .modal-content`);
      modalContent.classList.toggle('minimized');
      if (modalContent.classList.contains('maximized')) {
        modalContent.classList.remove('maximized');
      }
    }

    function maximizeModal(modalId) {
      const modalContent = document.querySelector(`#${modalId} .modal-content`);
      modalContent.classList.toggle('maximized');
      if (modalContent.classList.contains('minimized')) {
        modalContent.classList.remove('minimized');
      }
    }

    // Update existing close functions
    function closeAddModal() {
      if (document.getElementById('addRideForm').hasChanged) {
        confirmCancel('add');
      } else {
        const modal = document.getElementById('addRideModal');
        const modalContent = modal.querySelector('.modal-content');
        modalContent.classList.remove('minimized', 'maximized');
        modal.style.display = 'none';
      }
    }

    function closeUploadModal() {
      const modal = document.getElementById('uploadModal');
      const modalContent = modal.querySelector('.modal-content');
      modalContent.classList.remove('minimized', 'maximized');
      modal.style.display = 'none';
      selectedFile = null;
      document.getElementById('uploadMessage').textContent = '';
    }

    function closeEditModal() {
      const modal = document.getElementById('editModal');
      const modalContent = modal.querySelector('.modal-content');
      modalContent.classList.remove('minimized', 'maximized');
      modal.style.display = 'none';
      currentEditRideId = null;
    }

    // Add event listener for the select button
    document.addEventListener('DOMContentLoaded', function() {
      const selectButton = document.getElementById('selectButton');
      if (selectButton) {
        selectButton.addEventListener('click', handleFileUpload);
      }
    });

    function toggleAddRideMode() {
      document.getElementById('addRideModal').style.display = 'block';
    }

    function closeAddModal() {
      document.getElementById('addRideModal').style.display = 'none';
      document.getElementById('addRideForm').reset();
    }

    // Add form submission handler
    document.getElementById('addRideForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newRide = {
        plate_number: document.getElementById('addPlateNumber').value,
        route: document.getElementById('addRoute').value,
        departure: document.getElementById('addDeparture').value,
        capacity: parseInt(document.getElementById('addCapacity').value),
        ride_type: document.getElementById('addRideType').value,
        capacity: parseInt(document.getElementById('addCapacity').value), // Setting initial capacity same as seats_available
        queue: 1, // Default queue value
        time: new Date().toISOString() // Current time
      };

      try {
        const response = await fetch('/api/rides', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(newRide)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Ride added successfully:', result);
          alert('Ride added successfully!');
          closeAddModal();
          await fetchData(); // Refresh the ride list
        } else {
          const error = await response.json();
          throw new Error(error.message || 'Failed to add ride');
        }
      } catch (error) {
        console.error('Error adding ride:', error);
        alert('Failed to add ride: ' + error.message);
      }
    });

    function showSuccessMessage(message) {
      // Create the popup element
      const popup = document.createElement('div');
      popup.className = 'success-popup';
      popup.innerHTML = message + ' ✅';
      document.body.appendChild(popup);

      // Add styles for the popup
      popup.style.position = 'fixed';
      popup.style.top = '20px';
      popup.style.right = '20px';
      popup.style.backgroundColor = '#34A853';
      popup.style.color = 'white';
      popup.style.padding = '15px 25px';
      popup.style.borderRadius = '5px';
      popup.style.zIndex = '1000';
      popup.style.animation = 'slideIn 0.5s ease-out';

      // Remove the popup after 3 seconds
      setTimeout(() => {
        popup.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => {
          document.body.removeChild(popup);
        }, 500);
      }, 3000);
    }

    // Update your existing add ride function to use this
    document.getElementById('addRideForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Your existing form submission code here...

      try {
        // After successful submission
        showSuccessMessage('Ride is Added!');
        closeAddModal();
        await fetchData(); // If you're refreshing the ride list
      } catch (error) {
        console.error('Error:', error);
        alert(error.message);
      }
    });

    let isDeleteMode = false;

    function toggleDeleteMode() {
      const modal = document.getElementById('deleteRideModal');
      modal.style.display = 'block';
      
      // Populate delete modal with rides
      const deleteList = document.getElementById('deleteRidesList');
      deleteList.innerHTML = '';
      
      const rides = document.querySelectorAll('.ride-item:not(.header)');
      rides.forEach(ride => {
        const rideInfo = ride.querySelectorAll('p');
        const checkbox = document.createElement('div');
        checkbox.className = 'delete-ride-item';
        checkbox.innerHTML = `
          <input type="checkbox" class="ride-checkbox" value="${rideInfo[0].textContent}">
          <span>Ride ID: ${rideInfo[0].textContent} - ${rideInfo[3].textContent} (${rideInfo[4].textContent})</span>
        `;
        deleteList.appendChild(checkbox);
      });
    }

    function confirmDelete() {
      const selectedCheckboxes = document.querySelectorAll('.ride-checkbox:checked');
      const errorMessage = document.querySelector('#deleteRideModal .error-message');

      if (selectedCheckboxes.length === 0) {
        errorMessage.style.display = 'block';
        return;
      }

      const confirmModal = document.getElementById('confirmDeleteModal');
      confirmModal.style.display = 'block';
    }

    function closeConfirmModal() {
      document.getElementById('confirmDeleteModal').style.display = 'none';
    }

    function executeDelete() {
      const selectedCheckboxes = document.querySelectorAll('.ride-checkbox:checked');
      
      // Simulate deletion
      selectedCheckboxes.forEach(checkbox => {
        const rideId = checkbox.value;
        const rideElement = document.querySelector(`.ride-item:has(p:first-child:contains('${rideId}'))`);
        if (rideElement) rideElement.remove();
      });

      // Show success message
      showDeleteSuccessMessage(selectedCheckboxes.length);
      
      // Close both modals
      closeConfirmModal();
      exitDeleteMode();
    }

    function exitDeleteMode() {
      const modal = document.getElementById('deleteRideModal');
      modal.style.display = 'none';
      const errorMessage = modal.querySelector('.error-message');
      if (errorMessage) {
        errorMessage.style.display = 'none';
      }
    }

    function showDeleteSuccessMessage(count) {
      const popup = document.createElement('div');
      popup.className = 'success-popup';
      popup.innerHTML = `Successfully deleted ${count} ride${count > 1 ? 's' : ''} 🥲`;
      document.body.appendChild(popup);

      popup.style.position = 'fixed';
      popup.style.top = '20px';
      popup.style.right = '20px';
      popup.style.backgroundColor = '#34A853';
      popup.style.color = 'white';
      popup.style.padding = '15px 25px';
      popup.style.borderRadius = '5px';
      popup.style.zIndex = '1000';
      popup.style.animation = 'slideIn 0.5s ease-out';

      setTimeout(() => {
        popup.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => {
          document.body.removeChild(popup);
        }, 500);
      }, 3000);
    }
  </script>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('editModal')">─</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('editModal')">□</button>
        <button class="window-control close-btn" title="Close" onclick="closeEditModal()">×</button>
      </div>
      <h2>Edit Ride</h2>
      <form id="editRideForm">
        <div class="form-group">
          <label for="editPlateNumber">Plate Number:</label>
          <input type="text" id="editPlateNumber" required>
        </div>
        <div class="form-group">
          <label for="editRoute">Route:</label>
          <input type="text" id="editRoute" required>
        </div>
        <div class="form-group">
          <label for="editDeparture">Departure:</label>
          <input type="datetime-local" id="editDeparture" required>
        </div>
        <div class="form-group">
          <label for="editCapacity">Capacity:</label>
          <input type="number" id="editCapacity" required>
          <label for="editCapacity">Capacity:</label>
          <input type="number" id="editCapacity" required>
        </div>
        <div class="button-group">
          <button type="submit" class="save-btn">Save</button>
          <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="imagePreviewModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('imagePreviewModal')">─</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('imagePreviewModal')">□</button>
        <button class="window-control close-btn" title="Close" onclick="closeImagePreview()">×</button>
      </div>
      <img id="previewImage" src="" alt="Preview" style="max-width: 100%;">
    </div>
  </div>

  <!-- Add Ride Modal -->
  <div id="addRideModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('addRideModal')">─</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('addRideModal')">□</button>
        <button class="window-control close-btn" title="Close" onclick="closeAddModal()">×</button>
      </div>
      <h2>Add New Ride</h2>
      <form id="addRideForm">
        <div class="form-group">
          <label for="addPlateNumber">Plate Number:</label>
          <input type="text" id="addPlateNumber" required>
        </div>
        <div class="form-group">
          <label for="addRoute">Route:</label>
          <input type="text" id="addRoute" required>
        </div>
        <div class="form-group">
          <label for="addDeparture">Departure:</label>
          <input type="datetime-local" id="addDeparture" required>
        </div>
        <div class="form-group">
          <label for="addCapacity">Capacity:</label>
          <input type="number" id="addCapacity" required>
        </div>
        <div class="form-group">
          <label for="addRideType">Ride Type:</label>
          <select id="addRideType" required>
            <option value="Jeepney">Jeepney</option>
            <option value="Service">Service</option>
          </select>
        </div>
        <div class="button-group">
          <button type="submit" class="save-btn">Add Ride</button>
          <button type="button" class="cancel-btn" onclick="closeAddModal()">Cancel</button>
        </div>
      </form>
      <form id="addRideForm">
        <div class="form-group">
          <label for="addPlateNumber">Plate Number:</label>
          <input type="text" id="addPlateNumber" required>
        </div>
        <div class="form-group">
          <label for="addRoute">Route:</label>
          <input type="text" id="addRoute" required>
        </div>
        <div class="form-group">
          <label for="addDeparture">Departure:</label>
          <input type="datetime-local" id="addDeparture" required>
        </div>
        <div class="form-group">
          <label for="addCapacity">Capacity:</label>
          <input type="number" id="addCapacity" required>
        </div>
        <div class="form-group">
          <label for="addRideType">Ride Type:</label>
          <select id="addRideType" required>
            <option value="Jeepney">Jeepney</option>
            <option value="Service">Service</option>
          </select>
        </div>
        <div class="button-group">
          <button type="submit" class="save-btn">Add Ride</button>
          <button type="button" class="cancel-btn" onclick="closeAddModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Upload Image Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('uploadModal')">─</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('uploadModal')">□</button>
        <button class="window-control close-btn" title="Close" onclick="closeUploadModal()">×</button>
      </div>
      <h2>Upload Image</h2>
      <!-- rest of the upload modal content -->
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeConfirmModal()">&times;</span>
      <h2>Discard Changes?</h2>
      <!-- rest of the confirmation modal content -->
    </div>
  </div>

  <!-- Upload Image Modal -->
  <div id="uploadImageModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('uploadImageModal')">─</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('uploadImageModal')">□</button>
        <button class="window-control close-btn" title="Close" onclick="closeUploadImageModal()">×</button>
      </div>
      
      <div class="upload-area" id="dropZone">
        <div class="upload-message">
          Upload from device or drag your image here 📁
        </div>
        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png" hidden>
        <div id="uploadStatus" class="upload-status"></div>
        <div id="fileInfo" class="file-info"></div>
      </div>
      
      <div class="modal-buttons">
        <button id="selectButton" class="select-btn" disabled>Select</button>
        <button class="cancel-btn" onclick="closeUploadImageModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Delete Mode Controls -->
  <div class="delete-mode-controls">
    <button class="confirm-delete" onclick="confirmDelete()">Delete Selected</button>
    <button class="cancel-delete" onclick="exitDeleteMode()">Cancel</button>
    <div class="error-message">Please select at least one ride to delete.</div>
  </div>

  <!-- Add this modal HTML -->
  <div id="deleteRideModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" onclick="minimizeModal('deleteRideModal')">─</button>
        <button class="window-control maximize" onclick="maximizeModal('deleteRideModal')">□</button>
        <button class="window-control close-btn" onclick="exitDeleteMode()">×</button>
      </div>
      <h2>Delete Rides</h2>
      <div class="delete-content">
        <p>Select the rides you want to delete:</p>
        <div id="deleteRidesList"></div>
        <div class="error-message" style="display: none; color: #EA4335; margin: 10px 0;">
          Please select at least one ride to delete.
        </div>
        <div class="button-group">
          <button class="confirm-delete" onclick="confirmDelete()">Delete Selected</button>
          <button class="cancel-delete" onclick="exitDeleteMode()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add these modal windows -->
  <div id="confirmDeleteModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control close-btn" onclick="closeConfirmModal()">×</button>
      </div>
      <h3>Confirm Deletion</h3>
      <p>Are you sure you want to delete the selected rides?</p>
      <div class="button-group">
        <button type="button" onclick="executeDelete()">Yes</button>
        <button type="button" onclick="closeConfirmModal()">No</button>
      </div>
    </div>
  </div>
</body>
</html>
