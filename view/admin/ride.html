<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoGora - Ride Management</title>
  <link rel="stylesheet" href="admin.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Markazi+Text:wght@400..700&display=swap" rel="stylesheet">
  <script src="/api/ride_editor.js" defer></script>
  <link rel="icon" type="image/png" href="/assets/favicon.png">

  <style>
    /* Ride-specific styles */
    .image-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .image-buttons {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .window-controls {
      position: absolute;
      right: 10px;
      top: 10px;
      display: flex;
      gap: 8px;
    }

    .window-control {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      color: rgb(255, 255, 255);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .minimize {
      background-color: #edd132;
      color: black;
    }
    
    .maximize {
      background-color: #34A853;
      color: black;
    }
    
    .close-btn {
      background-color: #c73421;
      color: black;
    }

    .window-control:hover {
      opacity: 0.8;
    }

    .modal-content.minimized {
      transform: scale(0.7);
      width: 70%;
      margin-top: 80vh;
      opacity: 0.8;
    }

    .modal-content.maximized {
      width: 95vw;
      max-width: none;
      height: 90vh;
      margin: 5vh auto;
    }

    #imagePreviewModal .modal-content {
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      min-height: 400px;
    }

    #previewImage {
      max-width: 90%;
      max-height: 80vh;
      object-fit: contain;
      margin: auto;
      display: block;
    }

    /* Adjust the window controls to stay at the top */
    #imagePreviewModal .window-controls {
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 1001;

      padding: 5px;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="logo">
        <h2><span style="color: #4285F4;">Go</span><span style="color: #FBBC05;">Go</span><span style="color: #FBBC05;">Ra</span></h2>
      </div>
      <nav>
        <ul class="menu">
          <li><a href="index.html" class="menu-item"><i class="icon">üè†</i> Dashboard</a></li>
          <li><a href="ride_manager.html" class="menu-item"><i class="icon">üõ£Ô∏è</i> Manage Rides</a>
            <a href="ride.html" class="menu-item" style="padding-left: 45px;"><i class="icon">üöñ</i> Rides</a>
            <a href="schedules.html" class="menu-item" style="padding-left: 45px;"><i class="icon">üìÖ</i> Schedules</a>
          </li>
          <li><a href="account_manager.html" class="menu-item"><i class="icon">üë•</i> Manage Accounts</a></li>
          <li><a href="statistics.html" class="menu-item"><i class="icon">üìä</i> Statistics</a></li>
          <li><a href="blacklist.html" class="menu-item"><i class="icon">üö´</i> Blacklist Passengers</a></li>
        </ul>
      </nav>
    </aside>
    <main class="main-content">
      <div class="title-section">
        <h1>Manage Rides</h1>
      </div>

      <div class="search-filters">
        <h3> Search:</h3>
        <input type="text" id="searchInput" placeholder="Search Rides" oninput="filterRides()">
        <h3> Ride ID:</h3>
        <select id="filterPlateNumber">
          <option value="">Filter by Ride ID</option>
        </select>
          <h3> Route:</h3>
        <select id="filterRoute">
          <option value="">Filter by Route</option>
        </select>
          <h3> Departure:</h3>
        <select id="filterDeparture">
          <option value="">Filter by Departure</option>
        </select>
        <h3> Available Seats: </h3>
        <select id="filterSeatsAvailable">
          <option value="">Filter by Seats Available</option>
        </select>
        <button onclick="applyFilters()">Apply</button>
        <button onclick="clearFilters()">Clear All</button>
      </div>

      <div class="rides-section">
        <div class="header-buttons-container">
          <h2>Rides</h2>
          <div class="action-buttons">
            <button class="add-ride" onclick="toggleAddRideMode()">Add Ride</button>
            <button class="delete-ride" onclick="toggleDeleteMode()">Delete Ride</button>
            <button class="download-csv" onclick="downloadRidesCSV()">Download CSV</button>
          </div>
        </div>
        <div class="ride-item header">
          <p>Ride ID</p>
          <p>Plate Number</p>
          <p>Image</p>
          <p>Route</p>
          <p>Departure</p>
          <p>Seats Available</p>
        </div>
        <div id="rides-container">
          <!-- Ride items will be populated dynamically here -->
        </div>
      </div>

  <script>
    let allRides = [];  // Store all fetched rides

    // Fetch data for rides
    async function fetchData() {
      try {
        const ridesResponse = await fetch('/api/rides'); 
        if (!ridesResponse.ok) {
          throw new Error('Failed to fetch rides');
        }
        const rides = await ridesResponse.json();
        allRides = rides;
        displayRides(rides);
        populateFilters(rides);  // Populate the filter options
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('rides-container').innerHTML = `<p>Failed to load rides data.</p>`;
      }
    }

    // Display rides
    function displayRides(rides) {
      const ridesContainer = document.getElementById('rides-container');
      ridesContainer.innerHTML = ''; // Clear the container

      if (rides.length === 0) {
        ridesContainer.innerHTML = `<p style="color: gray;">Sorry ü•≤ There are no current rides available with the information you are looking for ü•≤</p>`;
        return;
      }

      rides.forEach(ride => {
        const rideItem = document.createElement('div');
        rideItem.className = 'ride-item';
        rideItem.innerHTML = `
          <p>${ride.ride_id}</p>
          <p>${ride.plate_number}</p>
          <div class="image-container">
            <img src="${ride.image || '/images/default-vehicle.jpg'}" alt="Image">
            <div class="image-buttons">
              <button onclick="previewImage('${ride.image}')" class="preview-btn">Preview</button>
              <button onclick="replaceImage(${ride.ride_id})" class="replace-btn">Replace</button>
            </div>
          </div>
          <p>${ride.route}</p>
          <p>${new Date(ride.departure).toLocaleString()}</p>
          <p>${ride.seats_available}</p>
          <button onclick="editRide(${ride.ride_id})" class="edit-btn">Edit</button>
        `;
        ridesContainer.appendChild(rideItem);
      });
    }

    // Filter rides based on search input
    function filterRides() {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const filteredRides = allRides.filter(ride => {
        return (
          ride.ride_id.toString().includes(searchInput) ||
          ride.plate_number.toLowerCase().includes(searchInput) ||
          ride.route.toLowerCase().includes(searchInput) ||
          ride.seats_available.toString().includes(searchInput)
        );
      });
      displayRides(filteredRides);
    }

    // Apply filters to the rides
    function applyFilters() {
      const plateNumber = document.getElementById('filterPlateNumber').value.toLowerCase();
      const route = document.getElementById('filterRoute').value.toLowerCase();
      const departure = document.getElementById('filterDeparture').value.toLowerCase();
      const seatsAvailable = document.getElementById('filterSeatsAvailable').value.toLowerCase();

      const filteredRides = allRides.filter(ride => {
        return (
          (plateNumber === "" || ride.ride_id.toString().includes(plateNumber)) &&
          (route === "" || ride.route.toLowerCase().includes(route)) &&
          (departure === "" || new Date(ride.departure).toLocaleDateString().includes(departure)) &&
          (seatsAvailable === "" || ride.seats_available.toString().includes(seatsAvailable))
        );
      });

      displayRides(filteredRides);
    }

    // Clear all filters
    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterPlateNumber').value = '';
      document.getElementById('filterRoute').value = '';
      document.getElementById('filterDeparture').value = '';
      document.getElementById('filterSeatsAvailable').value = '';
      displayRides(allRides);
    }

    // Populate filter dropdowns with dynamic values
    function populateFilters(rides) {
      const plateNumbers = [...new Set(rides.map(ride => ride.ride_id.toString()))];
      const routes = [...new Set(rides.map(ride => ride.route))];
      const departureDates = [...new Set(rides.map(ride => new Date(ride.departure).toLocaleDateString()))];
      const seatsAvailableOptions = [...new Set(rides.map(ride => ride.seats_available.toString()))];

      populateDropdown('filterPlateNumber', plateNumbers);
      populateDropdown('filterRoute', routes);
      populateDropdown('filterDeparture', departureDates);
      populateDropdown('filterSeatsAvailable', seatsAvailableOptions);
    }

    // Helper function to populate dropdown options
    function populateDropdown(selectId, options) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">All</option>';
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });
    }
    
        // Show Add Ride Modal
        function showAddRideModal() {
      // Code for showing the modal (if required)
      console.log("Show Add Ride Modal functionality");
    }

    // Update Ride
    function updateRide() {
      // Code for updating the ride in the database
    }

    // Delete Ride
    async function deleteRide(rideId) {
      const response = await fetch(`/routes/rides/${rideId}`, {
        method: 'DELETE',
      });
      if (response.ok) {
        fetchRides();
      }
    }
    
    // Download rides data as CSV
    async function downloadRidesCSV() {
      const rides = allRides;
      const csvRows = [
        ['Ride ID', 'Plate Number', 'Route', 'Seats Available', 'Departure', 'Image'],
        ...rides.map(ride => [
          ride.ride_id,
          ride.plate_number,
          ride.route,
          ride.seats_available,
          new Date(ride.departure).toLocaleString(),
          ride.image_url,
        ]),
      ];

      const csvContent = csvRows.map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'rides.csv';
      link.click();
    }

    // Fetch data when the page loads
    fetchData();

    let currentEditRideId = null;

    function editRide(rideId) {
      currentEditRideId = rideId;
      const ride = allRides.find(r => r.ride_id === rideId);
      
      // Populate the form with current values
      document.getElementById('editPlateNumber').value = ride.plate_number;
      document.getElementById('editRoute').value = ride.route;
      document.getElementById('editDeparture').value = new Date(ride.departure).toISOString().slice(0, 16);
      document.getElementById('editSeatsAvailable').value = ride.seats_available;
      
      // Show the modal
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditRideId = null;
      // Reset form
      document.getElementById('editRideForm').reset();
    }

    function previewImage(imageUrl) {
      const previewImg = document.getElementById('previewImage');
      previewImg.src = imageUrl || '/images/default-vehicle.jpg';
      document.getElementById('imagePreviewModal').style.display = 'block';
    }

    function closeImagePreview() {
      document.getElementById('imagePreviewModal').style.display = 'none';
    }

    function replaceImage(rideId) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          const formData = new FormData();
          formData.append('image', file);
          formData.append('ride_id', rideId);
          
          try {
            const response = await fetch('/api/rides/update-image', {
              method: 'POST',
              body: formData
            });
            
            if (response.ok) {
              alert('Image updated successfully!');
              fetchData(); // Refresh the ride list
            } else {
              throw new Error('Failed to update image');
            }
          } catch (error) {
            console.error('Error updating image:', error);
            alert('Failed to update image');
          }
        }
      };
      input.click();
    }

    // Update the form submission handler
    document.getElementById('editRideForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const updatedRide = {
        ride_id: currentEditRideId, // Add the ride_id
        plate_number: document.getElementById('editPlateNumber').value,
        route: document.getElementById('editRoute').value,
        departure: document.getElementById('editDeparture').value,
        seats_available: parseInt(document.getElementById('editSeatsAvailable').value)
      };

      try {
        const response = await fetch(`/api/rides/${currentEditRideId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedRide)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Update successful:', result);
          alert('Ride updated successfully!');
          closeEditModal();
          await fetchData(); // Refresh the ride list
        } else {
          const error = await response.json();
          throw new Error(error.message || 'Failed to update ride');
        }
      } catch (error) {
        console.error('Error updating ride:', error);
        alert('Failed to update ride: ' + error.message);
      }
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
      const editModal = document.getElementById('editModal');
      const imagePreviewModal = document.getElementById('imagePreviewModal');
      if (event.target === editModal) {
        closeEditModal();
      }
      if (event.target === imagePreviewModal) {
        closeImagePreview();
      }
    }

    function closeAddModal() {
      if (document.getElementById('addRideForm').hasChanged) {
        confirmCancel('add');
      } else {
        document.getElementById('addRideModal').style.display = 'none';
      }
    }

    // Window control functions
    function minimizeModal(modalId) {
      const modalContent = document.querySelector(`#${modalId} .modal-content`);
      modalContent.classList.toggle('minimized');
      if (modalContent.classList.contains('maximized')) {
        modalContent.classList.remove('maximized');
      }
    }

    function maximizeModal(modalId) {
      const modalContent = document.querySelector(`#${modalId} .modal-content`);
      modalContent.classList.toggle('maximized');
      if (modalContent.classList.contains('minimized')) {
        modalContent.classList.remove('minimized');
      }
    }

    // Update existing close functions
    function closeAddModal() {
      if (document.getElementById('addRideForm').hasChanged) {
        confirmCancel('add');
      } else {
        const modal = document.getElementById('addRideModal');
        const modalContent = modal.querySelector('.modal-content');
        modalContent.classList.remove('minimized', 'maximized');
        modal.style.display = 'none';
      }
    }

    function closeUploadModal() {
      const modal = document.getElementById('uploadModal');
      const modalContent = modal.querySelector('.modal-content');
      modalContent.classList.remove('minimized', 'maximized');
      modal.style.display = 'none';
      selectedFile = null;
      document.getElementById('uploadMessage').textContent = '';
    }

    function closeEditModal() {
      const modal = document.getElementById('editModal');
      const modalContent = modal.querySelector('.modal-content');
      modalContent.classList.remove('minimized', 'maximized');
      modal.style.display = 'none';
      currentEditRideId = null;
    }
  </script>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('editModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('editModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="closeEditModal()">√ó</button>
      </div>
      <h2>Edit Ride</h2>
      <form id="editRideForm">
        <div class="form-group">
          <label for="editPlateNumber">Plate Number:</label>
          <input type="text" id="editPlateNumber" required>
        </div>
        <div class="form-group">
          <label for="editRoute">Route:</label>
          <input type="text" id="editRoute" required>
        </div>
        <div class="form-group">
          <label for="editDeparture">Departure:</label>
          <input type="datetime-local" id="editDeparture" required>
        </div>
        <div class="form-group">
          <label for="editSeatsAvailable">Seats Available:</label>
          <input type="number" id="editSeatsAvailable" required>
        </div>
        <div class="button-group">
          <button type="submit" class="save-btn">Save</button>
          <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="imagePreviewModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('imagePreviewModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('imagePreviewModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="closeImagePreview()">√ó</button>
      </div>
      <img id="previewImage" src="" alt="Preview" style="max-width: 100%;">
    </div>
  </div>

  <!-- Add Ride Modal -->
  <div id="addRideModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('addRideModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('addRideModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="closeAddModal()">√ó</button>
      </div>
      <h2>Add New Ride</h2>
      <!-- rest of the add ride form content -->
    </div>
  </div>

  <!-- Upload Image Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <div class="window-controls">
        <button class="window-control minimize" title="Minimize" onclick="minimizeModal('uploadModal')">‚îÄ</button>
        <button class="window-control maximize" title="Maximize" onclick="maximizeModal('uploadModal')">‚ñ°</button>
        <button class="window-control close-btn" title="Close" onclick="closeUploadModal()">√ó</button>
      </div>
      <h2>Upload Image</h2>
      <!-- rest of the upload modal content -->
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeConfirmModal()">&times;</span>
      <h2>Discard Changes?</h2>
      <!-- rest of the confirmation modal content -->
    </div>
  </div>
</body>
</html>
